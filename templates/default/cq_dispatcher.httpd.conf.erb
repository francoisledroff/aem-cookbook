# This file was generated by Chef for <%= node['fqdn'] %>.
# Do NOT modify this file by hand!

#############################
# CQ Dispatcher Configuration
#############################


# CQ DISPATCHER module
LoadModule dispatcher_module "<%= node['apache']['cq_dispatcher_module_file_relpath'] %>"

<IfModule disp_apache2.c>
   # location of the configuration file
   DispatcherConfig <%= node['apache']['cq_dispatcher_module_config_file_path'] %>

   # location of the dispatcher log file. eg: 'logs/dispatcher.log'
   DispatcherLog <%= node['apache']['cq_dispatcher_log_file_path'] %>
   
   # log level for the dispatcher log
   # 0 Errors
   # 1 Warnings
   # 2 Infos
   # 3 Debug
   DispatcherLogLevel <%= node['apache']['cq_dispatcher_log_level'] %>

   # Defines the Server Header to be used:
   # undefined or 0 - the HTTP server header contains the CQ version.
   # if turned to 1, Apache server header is used
   DispatcherNoServerHeader <%= node['apache']['cq_dispatcher_no_server_header'] %>

   # if turned to 1, request to / are not handled by the dispatcher
   # use the mod_alias then for the correct mapping
   DispatcherDeclineRoot <%= node['apache']['cq_dispatcher_decline_root'] %>
   
   # Defines whether to use pre-processed URLs:
   # 0 - use the original URL passed to the web server.
   # 1 - the dispatcher uses the URL already processed by the handlers
   # that precede the dispatcher
   # (i.e. mod_rewrite) instead of the original URL passed to the server.
   

   DispatcherUseProcessedURL <%= node['apache']['cq_dispatcher_use_processed_url'] %>
   DispatcherPassError <%= node['apache']['cq_dispatcher_pass_error'] %>
</IfModule>

#
# Each directory to which Apache has access can be configured with respect
# to which services and features are allowed and/or disabled in that
# directory (and its subdirectories).
#
# First, we configure the "default" to be a very restrictive set of
# features.
#
<Directory />
   <IfModule disp_apache2.c>
     SetHandler dispatcher-handler
     ModMimeUsePathInfo On
   </IfModule>

   Options FollowSymLinks
   AllowOverride All
</Directory>

#####################
# Cache Configuration
#####################

<IfModule expires_module>

ExpiresActive On

# Setting to expiry to "now" will force the clients to re-validate cached content,
# replacing if and only if the last-modified or etag values differ.
# Using "access + 5 minutes" provides better optimization since the browser
# won't try to validate at all within that time-frame, reducing the chatter
# significantly.

# Cache most content for X minutes before triggering the browser to perform re-validation.
# For DEVELOPMENT set default to "now" in order to always re-validate and stay up-to-date with
# your development re-deployments.
# ExpiresDefault "now"

ExpiresDefault "access plus 5 minutes"

# Photos are somewhat sensitive and are cached for a defined period.

<LocationMatch "/content/yourphotos/photos/*">
ExpiresDefault "access plus 7 days"
</LocationMatch>

# The url *may* not reflect json data is coming back; add insurance
# expiry by content type directive.

# Don't cache any json mime-type content.

ExpiresByType application/json "now"

</IfModule>

<IfModule headers_module>

# Sensitive content must not be cached by browsers

# Don't cache any urls that look like json content.

<LocationMatch "\.(json)$">
FileETag None
Header unset ETag
Header set Cache-Control "max-age=0, no-cache, no-store, must-revalidate"
Header set Pragma "no-cache"
Header set Expires "Wed, 11 Jan 1984 05:00:00 GMT"
</LocationMatch>

# Don't cache CQ sling requests.

<LocationMatch "^/system/sling/*">
FileETag None
Header unset ETag
Header set Cache-Control "max-age=0, no-cache, no-store, must-revalidate"
Header set Pragma "no-cache"
Header set Expires "Wed, 11 Jan 1984 05:00:00 GMT"
</LocationMatch>

# Don't cache any urls that look like urlShortener requests.

<LocationMatch "\.(ly)$">
FileETag None
Header unset ETag
Header set Cache-Control "max-age=0, no-cache, no-store, must-revalidate"
Header set Pragma "no-cache"
Header set Expires "Wed, 11 Jan 1984 05:00:00 GMT"
</LocationMatch>

</IfModule>



